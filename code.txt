import requests
from typing import List
from langchain.embeddings.base import Embeddings

class CustomEmbeddingClient(Embeddings):
    def __init__(self, api_url: str, api_key: str):
        """
        初始化自定义 Embedding Client。

        :param api_url: Embedding API 的 URL。
        :param api_key: API 密钥。
        """
        self.api_url = api_url
        self.api_key = api_key

    def embed_documents(self, texts: List[str]) -> List[List[float]]:
        """
        对多个文档生成 Embedding。

        :param texts: 需要生成 Embedding 的文本列表。
        :return: Embedding 列表。
        """
        embeddings = []
        for text in texts:
            embedding = self._send_embedding_request(text)
            embeddings.append(embedding)
        return embeddings

    def embed_query(self, text: str) -> List[float]:
        """
        对单个查询生成 Embedding。

        :param text: 需要生成 Embedding 的文本。
        :return: Embedding 向量。
        """
        return self._send_embedding_request(text)

    def _send_embedding_request(self, text: str) -> List[float]:
        """
        发送 Embedding 请求并返回结果。

        :param text: 需要生成 Embedding 的文本。
        :return: Embedding 向量。
        """
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.api_key}"
        }
        data = {
            "input": text,
            "model": "your-embedding-model"  # 替换为你的 Embedding 模型名称
        }
        response = requests.post(self.api_url, headers=headers, json=data)
        if response.status_code == 200:
            return response.json()["data"][0]["embedding"]  # 根据 API 返回格式调整
        else:
            raise Exception(f"Embedding request failed: {response.status_code}, {response.text}")

# 使用示例
if __name__ == "__main__":
    # 初始化自定义 Embedding Client
    api_url = "https://api.example.com/embeddings"  # 替换为你的 Embedding API URL
    api_key = "your-api-key"  # 替换为你的 API 密钥
    embedding_client = CustomEmbeddingClient(api_url, api_key)

    # 生成单个查询的 Embedding
    query_embedding = embedding_client.embed_query("Hello, world!")
    print("Query Embedding:", query_embedding)

    # 生成多个文档的 Embedding
    document_embeddings = embedding_client.embed_documents(["Text 1", "Text 2", "Text 3"])
    print("Document Embeddings:", document_embeddings)